git:
  submodules: false
dist: bionic
language: php
php:
  - '7.3'
services:
  - docker
  - mysql
addons:
  chrome: stable
cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/cache/
before_install:
  - mysql -e 'CREATE DATABASE testing;'
install:
  - phpenv config-rm xdebug.ini
  - composer selfupdate --1
  - bash ./scripts/ci/composer--create.sh
  - bash ./scripts/ci/composer--install.sh
  - bash ./scripts/ci/composer--postinstall.sh
  - bash ./scripts/ci/inject_code.sh
jobs:
  include:
    # - stage: "Checks"
    #   name: "Coding standards"
    #   script:
    #     - bash ./scripts/ci/checks--cs.sh
    # - script: bash ./scripts/ci/checks--phpstan.sh
    #   name: "PHPstan"
    # - script: bash ./scripts/ci/checks--npmaudit.sh
    #   name: Npm audit
    # - stage: "Unit Tests"
    #   name: "PHPUnit"
    #   script: bash ./scripts/ci/tests--phpunit.sh
    - stage: "Behat tests"
      name: "Install"
      script:
        - if [[ ! -f $HOME/cache/db.sql ]];then export CI_MYSQL_USERNAME="root"; bash ./scripts/ci/tests--integration--db-import.sh; fi
        - if [[ -f /tmp/db.sql ]]; then cp /tmp/db.sql $HOME/cache/db.sql; else $HOME/cache/db.sql /tmp/db.sql; fi
        - bash ./scripts/ci/setup_chromedriver.sh
        - bash ./scripts/ci/start_chromedriver.sh
        #- google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
        - bash ./scripts/ci/tests--integration.sh content
